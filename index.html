<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TryFi Wallet Widget Demo</title>
</head>
<body>
    <!-- Demo dApp interface -->
    <div style="padding: 40px; text-align: center; font-family: Arial, sans-serif;">
        <h1>ðŸŽ® Demo dApp</h1>
        <p>Click the TryFi button to get started with a demo wallet!</p>
        
        <div style="margin: 20px 0;">
            <button onclick="connectWallet()" style="background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                Connect Wallet
            </button>
            <button onclick="testTryFi()" style="background: #f59e0b; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-left: 10px;">
                Test TryFi
            </button>
        </div>
        
        <div id="wallet-info" style="margin-top: 20px; padding: 20px; background: #f3f4f6; border-radius: 8px; display: none;">
            <p><strong>Connected:</strong> <span id="wallet-address"></span></p>
            <p><strong>Balance:</strong> <span id="wallet-balance"></span> ETH</p>
            <button onclick="sendTransaction()" style="background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
                Send Test Transaction
            </button>
            <button onclick="signMessage()" style="background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
                Sign Message
            </button>
        </div>
    </div>

    <!-- TryFi Widget -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.14.3/dist/ethers.umd.min.js"></script>
    <script>
        // Check if ethers loaded
        console.log('Ethers loaded:', typeof ethers !== 'undefined');
        
        if (typeof ethers === 'undefined') {
            alert('Failed to load Ethers library');
            throw new Error('Ethers library is required');
        }

        // TryFi Configuration
        const TRYFI_CONFIG = {
            network: 'sepolia',
            rpcUrl: 'https://1rpc.io/sepolia',
            chainId: 11155111,
            position: 'bottom-right'
        };

        // TryFi Wallet Class
        class TryFiWallet {
            constructor(config) {
                this.config = config;
                this.wallet = null;
                this.provider = null;
                this.isActive = false;
                this.transactions = [];
                this.originalEthereum = window.ethereum;
                
                this.init();
            }

            init() {
                console.log('TryFi: Initializing...');
                this.createWidget();
                this.setupEventListeners();
                this.loadWallet();
                console.log('TryFi: Ready!');
            }

            createWidget() {
                // Widget styles
                const styles = `
                    .tryfi-widget {
                        position: fixed;
                        ${this.config.position.includes('right') ? 'right: 20px;' : 'left: 20px;'}
                        ${this.config.position.includes('bottom') ? 'bottom: 20px;' : 'top: 20px;'}
                        z-index: 10000;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    }
                    
                    .tryfi-button {
                        width: 60px;
                        height: 60px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        transition: transform 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .tryfi-button:hover {
                        transform: scale(1.05);
                    }
                    
                    .tryfi-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: none;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                    }
                    
                    .tryfi-modal-content {
                        background: white;
                        border-radius: 12px;
                        padding: 24px;
                        width: 90%;
                        max-width: 400px;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                    }
                    
                    .tryfi-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 16px;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    
                    .tryfi-close {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #6b7280;
                    }
                    
                    .tryfi-wallet-info {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    
                    .tryfi-address {
                        background: #f3f4f6;
                        padding: 8px 12px;
                        border-radius: 8px;
                        font-family: monospace;
                        font-size: 12px;
                        margin: 8px 0;
                        word-break: break-all;
                        cursor: pointer;
                    }
                    
                    .tryfi-balance {
                        font-size: 24px;
                        font-weight: bold;
                        color: #1f2937;
                        margin: 12px 0;
                    }
                    
                    .tryfi-actions {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    
                    .tryfi-btn {
                        padding: 12px;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: background-color 0.2s;
                        text-decoration: none;
                        display: block;
                        text-align: center;
                    }
                    
                    .tryfi-btn-primary {
                        background: #3b82f6;
                        color: white;
                    }
                    
                    .tryfi-btn-primary:hover {
                        background: #2563eb;
                    }
                    
                    .tryfi-btn-secondary {
                        background: #e5e7eb;
                        color: #374151;
                    }
                    
                    .tryfi-btn-secondary:hover {
                        background: #d1d5db;
                    }
                    
                    .tryfi-input {
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        margin-bottom: 12px;
                        font-size: 14px;
                        box-sizing: border-box;
                    }
                    
                    .tryfi-input:focus {
                        outline: none;
                        border-color: #3b82f6;
                    }
                `;

                // Inject styles
                const styleSheet = document.createElement('style');
                styleSheet.textContent = styles;
                document.head.appendChild(styleSheet);

                // Create widget HTML
                const widget = document.createElement('div');
                widget.className = 'tryfi-widget';
                widget.innerHTML = `
                    <button class="tryfi-button" id="tryfi-toggle">
                        ðŸ”¥
                    </button>
                    
                    <div class="tryfi-modal" id="tryfi-modal">
                        <div class="tryfi-modal-content">
                            <div class="tryfi-header">
                                <h3 style="margin: 0; color: #1f2937;">ðŸ”¥ TryFi Wallet</h3>
                                <button class="tryfi-close" id="tryfi-close">Ã—</button>
                            </div>
                            
                            <div id="tryfi-content">
                                Loading...
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(widget);
            }

            setupEventListeners() {
                document.getElementById('tryfi-toggle').onclick = () => this.toggleWidget();
                document.getElementById('tryfi-close').onclick = () => this.hideWidget();
                document.getElementById('tryfi-modal').onclick = (e) => {
                    if (e.target.id === 'tryfi-modal') this.hideWidget();
                };
            }

            loadWallet() {
                this.provider = new ethers.JsonRpcProvider(this.config.rpcUrl);
                
                const savedWallet = localStorage.getItem('tryfi-wallet');
                if (savedWallet) {
                    const walletData = JSON.parse(savedWallet);
                    this.wallet = new ethers.Wallet(walletData.privateKey, this.provider);
                    this.transactions = walletData.transactions || [];
                    console.log('TryFi: Loaded existing wallet:', this.wallet.address);
                }
            }

            async createWallet() {
                console.log('TryFi: Creating wallet...');
                try {
                    this.wallet = ethers.Wallet.createRandom().connect(this.provider);
                    this.transactions = [];
                    console.log('TryFi: Wallet created:', this.wallet.address);
                    
                    this.saveWallet();
                    this.updateContent();
                } catch (error) {
                    console.error('TryFi: Wallet creation failed:', error);
                    alert('Failed to create wallet: ' + error.message);
                }
            }

            saveWallet() {
                if (!this.wallet) return;
                
                const walletData = {
                    privateKey: this.wallet.privateKey,
                    transactions: this.transactions
                };
                localStorage.setItem('tryfi-wallet', JSON.stringify(walletData));
            }

            async getBalance() {
                if (!this.wallet) return '0.0';
                
                try {
                    const balance = await this.provider.getBalance(this.wallet.address);
                    return ethers.formatEther(balance);
                } catch (error) {
                    console.error('Error getting balance:', error);
                    return '0.0';
                }
            }

            updateContent() {
                const content = document.getElementById('tryfi-content');
                
                if (!this.wallet) {
                    content.innerHTML = `
                        <div style="text-align: center;">
                            <p>Create a demo wallet to try this dApp!</p>
                            <button class="tryfi-btn tryfi-btn-primary" onclick="window.tryfi.createWallet()" style="width: 100%;">
                                ðŸš€ Create Wallet
                            </button>
                        </div>
                    `;
                    return;
                }

                // Show loading first
                content.innerHTML = `
                    <div class="tryfi-wallet-info">
                        <div class="tryfi-balance">Loading...</div>
                        <div class="tryfi-address" onclick="navigator.clipboard.writeText('${this.wallet.address}')" title="Click to copy" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-family: monospace;">${this.wallet.address}</span>
                            <button class="tryfi-btn-icon" onclick="event.stopPropagation(); navigator.clipboard.writeText('${this.wallet.address}'); alert('Address copied!');" style="background: none; border: none; cursor: pointer; padding: 4px;">ðŸ“‹</button>
                        </div>
                    </div>
                    
                    <div class="tryfi-actions">
                        <button class="tryfi-btn tryfi-btn-primary" onclick="window.tryfi.activateProvider()">ðŸ”— Connect</button>
                        <button class="tryfi-btn tryfi-btn-secondary" onclick="window.tryfi.showSendForm()">ðŸ’¸ Send</button>
                        <button class="tryfi-btn tryfi-btn-secondary" onclick="window.tryfi.endSession()">ðŸ”š End Session</button>
                        <a href="https://sepoliafaucet.com" target="_blank" class="tryfi-btn tryfi-btn-secondary">ðŸš° Get ETH</a>
                    </div>
                `;

                // Update balance async
                this.getBalance().then(balance => {
                    const balanceEl = document.querySelector('.tryfi-balance');
                    if (balanceEl) {
                        balanceEl.textContent = `${balance} ETH`;
                    }
                });
            }

            showSendForm() {
                const content = document.getElementById('tryfi-content');
                content.innerHTML = `
                    <h4>Send ETH</h4>
                    <div>
                        <input type="text" class="tryfi-input" id="send-to" placeholder="To Address (0x...)">
                        <input type="number" class="tryfi-input" id="send-amount" placeholder="Amount (ETH)" step="0.001">
                        <div class="tryfi-actions">
                            <button class="tryfi-btn tryfi-btn-secondary" onclick="window.tryfi.updateContent()">Cancel</button>
                            <button class="tryfi-btn tryfi-btn-primary" onclick="window.tryfi.sendETH()">Send</button>
                        </div>
                    </div>
                `;
            }

            async sendETH() {
                const to = document.getElementById('send-to').value;
                const amount = document.getElementById('send-amount').value;
                
                if (!to || !amount) {
                    alert('Please fill all fields');
                    return;
                }
                
                try {
                    const tx = await this.handleSendTransaction({
                        to: to,
                        value: ethers.parseEther(amount)
                    });
                    alert(`Transaction sent: ${tx}`);
                    this.updateContent();
                } catch (error) {
                    alert(`Transaction failed: ${error.message}`);
                }
            }

            resetWallet() {
                if (confirm('End this session? This will delete the wallet and disconnect from dApps.')) {
                    localStorage.removeItem('tryfi-wallet');
                    this.wallet = null;
                    this.transactions = [];
                    this.deactivateProvider();
                    this.updateContent();
                }
            }

            endSession() {
                if (confirm('End this session? This will delete the wallet and disconnect from dApps.')) {
                    // Remove wallet data
                    localStorage.removeItem('tryfi-wallet');
                    this.wallet = null;
                    this.transactions = [];
                    
                    // Restore original ethereum provider
                    window.ethereum = this.originalEthereum;
                    this.isActive = false;
                    
                    // Update UI
                    this.updateContent();
                    
                    // Hide wallet info in main dApp
                    document.getElementById('wallet-info').style.display = 'none';
                    
                    alert('Session ended. Wallet deleted and disconnected.');
                }
            }

            toggleWidget() {
                const modal = document.getElementById('tryfi-modal');
                if (modal.style.display === 'flex') {
                    this.hideWidget();
                } else {
                    this.showWidget();
                }
            }

            showWidget() {
                document.getElementById('tryfi-modal').style.display = 'flex';
                this.updateContent();
            }

            hideWidget() {
                document.getElementById('tryfi-modal').style.display = 'none';
            }

            // EIP-1193 Provider
            activateProvider() {
                if (this.isActive) return;
                
                this.isActive = true;
                window.ethereum = this.createEIP1193Provider();
                alert('TryFi provider activated! Try "Connect Wallet" now.');
            }

            deactivateProvider() {
                if (!this.isActive) return;
                
                this.isActive = false;
                window.ethereum = this.originalEthereum;
            }

            createEIP1193Provider() {
                const self = this;
                
                return {
                    isTryFi: true,
                    chainId: '0x' + this.config.chainId.toString(16),
                    
                    async request({ method, params = [] }) {
                        console.log('TryFi Provider:', method, params);
                        
                        switch (method) {
                            case 'eth_requestAccounts':
                                if (!self.wallet) {
                                    await self.createWallet();
                                }
                                return [self.wallet.address];
                            
                            case 'eth_accounts':
                                return self.wallet ? [self.wallet.address] : [];
                            
                            case 'eth_chainId':
                                return '0x' + self.config.chainId.toString(16);
                            
                            case 'eth_getBalance':
                                const balance = await self.getBalance();
                                return '0x' + Math.floor(parseFloat(balance) * 1e18).toString(16);
                            
                            case 'eth_sendTransaction':
                                return await self.handleSendTransaction(params[0]);
                            
                            case 'personal_sign':
                                return await self.handleSign(params[0]);
                            
                            default:
                                throw new Error(`Method ${method} not supported`);
                        }
                    },
                    
                    on() {},
                    removeListener() {}
                };
            }

            async handleSendTransaction(txParams) {
                if (!this.wallet) throw new Error('No wallet');
                
                const confirmed = confirm(`Send ${ethers.formatEther(txParams.value || '0')} ETH to ${txParams.to}?`);
                if (!confirmed) {
                    throw new Error('User rejected transaction');
                }
                
                try {
                    const tx = await this.wallet.sendTransaction({
                        to: txParams.to,
                        value: txParams.value || 0,
                        gasLimit: txParams.gas || '21000'
                    });
                    
                    return tx.hash;
                } catch (error) {
                    console.error('Transaction failed:', error);
                    throw error;
                }
            }

            async handleSign(message) {
                if (!this.wallet) throw new Error('No wallet');
                
                const confirmed = confirm(`Sign message: "${message}"?`);
                if (!confirmed) {
                    throw new Error('User rejected signing');
                }
                
                return await this.wallet.signMessage(message);
            }
        }

        // Initialize TryFi
        window.tryfi = new TryFiWallet(TRYFI_CONFIG);

        // Expose API
        window.TryFi = {
            init: (config) => {
                Object.assign(TRYFI_CONFIG, config);
                window.tryfi = new TryFiWallet(TRYFI_CONFIG);
            }
        };

        // Demo functions
        function testTryFi() {
            console.log('Testing TryFi...');
            if (window.tryfi) {
                window.tryfi.showWidget();
            } else {
                alert('TryFi not ready!');
            }
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('No wallet provider! Click TryFi button first.');
                    return;
                }
                
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const balance = await window.ethereum.request({ 
                    method: 'eth_getBalance', 
                    params: [accounts[0], 'latest'] 
                });
                
                document.getElementById('wallet-address').textContent = 
                    accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                document.getElementById('wallet-balance').textContent = 
                    (parseInt(balance, 16) / 1e18).toFixed(4);
                document.getElementById('wallet-info').style.display = 'block';
                
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        }

        async function sendTransaction() {
            try {
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        to: '0x742d35Cc6634C0532925a3b8D1B3C80C18e70100',
                        value: '0x2386f26fc10000' // 0.01 ETH
                    }]
                });
                alert('Transaction sent: ' + txHash);
            } catch (error) {
                alert('Transaction failed: ' + error.message);
            }
        }

        async function signMessage() {
            try {
                const accounts = await window.ethereum.request({method: 'eth_accounts'});
                const signature = await window.ethereum.request({
                    method: 'personal_sign',
                    params: ['Hello from TryFi!', accounts[0]]
                });
                alert('Message signed: ' + signature.slice(0, 20) + '...');
            } catch (error) {
                alert('Signing failed: ' + error.message);
            }
        }
    </script>
</body>
</html>